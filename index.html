<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Training Log</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    h1, h2 {
      color: #333;
    }
    .card {
      background: white;
      padding: 15px;
      margin-bottom: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    label {
      display: block;
      margin-top: 10px;
    }
    input, select, button {
      width: 100%;
      padding: 8px;
      margin-top: 5px;
    }
    button {
      margin-top: 15px;
      background: #007bff;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
    ul {
      padding-left: 20px;
    }
    .feedback {
      font-weight: bold;
      color: #006400;
    }
    .form-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 10px;
  margin-bottom: 10px;
}

.form-grid input,
.form-grid select {
  padding: 6px;
  font-size: 14px;
}

.form-grid label {
  font-size: 12px;
  color: #555;
}
  </style>
</head>
<body>

<h1>üèä‚Äç‚ôÇÔ∏èüö¥‚Äç‚ôÇÔ∏èüèÉ‚Äç‚ôÇÔ∏è My Training Dashboard</h1>

<div class="card">
  <h2>Log Training</h2>

  <div class="form-grid">
    <div>
      <label>Date</label>
      <input type="date" id="date" />
    </div>

    <div>
      <label>Activity</label>
      <select id="activity">
        <option value="run">Run</option>
        <option value="bike">Bike</option>
        <option value="swim">Swim</option>
        <option value="badminton">Badminton</option>
      </select>
    </div>

    <div>
      <label>Distance (km)</label>
      <input type="number" id="distance" step="0.1" />
    </div>

    <div>
      <label>Duration (min)</label>
      <input type="number" id="duration" />
    </div>

    <div>
      <label>Notes</label>
      <input type="text" id="notes" />
    </div>
  </div>

  <button onclick="saveLog()">Save</button>
</div>

<div class="card">
  <h2>Weekly Summary</h2>
  <p id="summary"></p>
  <p class="feedback" id="coachFeedback"></p>
</div>

<div class="card">
  <h2>Training History</h2>
  <ul id="history"></ul>
</div>

<div class="card">
  <h2>Weekly Volume Chart</h2>
  <canvas id="chart"></canvas>
</div>

<script>
  const API_BASE = "https://trifit-api.wheezhacker.workers.dev";

  let logs = [];
  let chartInstance = null;

  async function apiGetLogs() {
    const res = await fetch(`${API_BASE}/api/logs`);
    const data = await res.json();
    return data.logs || [];
  }

  async function apiAddLog(log) {
    const res = await fetch(`${API_BASE}/api/logs`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(log),
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to save");
    return data.log;
  }

  async function apiDeleteLog(id) {
    const res = await fetch(`${API_BASE}/api/logs?id=${encodeURIComponent(id)}`, {
      method: "DELETE",
    });
    const data = await res.json();
    if (!data.ok) throw new Error(data.error || "Failed to delete");
    return true;
  }

  function setStatus(msg) {
    // Optional: show status in console for now
    console.log(msg);
  }

  async function saveLog() {
    const log = {
      date: document.getElementById("date").value,
      activity: document.getElementById("activity").value,
      distance: Number(document.getElementById("distance").value || 0),
      duration: Number(document.getElementById("duration").value || 0),
      notes: document.getElementById("notes").value || "",
    };

    if (!log.date || !log.duration) {
      alert("Please fill in at least date and duration");
      return;
    }

    try {
      setStatus("Saving log...");
      await apiAddLog(log);

      // Clear inputs (optional)
      document.getElementById("distance").value = "";
      document.getElementById("duration").value = "";
      document.getElementById("notes").value = "";

      await loadAndRender();
      setStatus("Saved.");
    } catch (e) {
      alert(`Save failed: ${e.message}`);
    }
  }

  async function deleteLog(id) {
    if (!confirm("Delete this record?")) return;
    try {
      setStatus("Deleting log...");
      await apiDeleteLog(id);
      await loadAndRender();
      setStatus("Deleted.");
    } catch (e) {
      alert(`Delete failed: ${e.message}`);
    }
  }

  async function loadAndRender() {
    logs = await apiGetLogs();
    render();
  }

  function render() {
    renderHistory();
    renderSummary();
    renderChart();
  }

  function renderHistory() {
    const ul = document.getElementById("history");
    ul.innerHTML = "";

    logs
      .slice()
      .reverse()
      .forEach((l) => {
        const li = document.createElement("li");

        li.innerHTML = `
          ${l.date} ‚Äì ${l.activity} ‚Äì ${(l.distance || 0).toFixed(2)}km ‚Äì ${l.duration}min
          <button onclick="deleteLog('${l.id}')">‚ùå</button>
        `;

        ul.appendChild(li);
      });
  }

  function renderSummary() {
    let totals = { run: 0, bike: 0, swim: 0, badminton: 0 };
    let badmintonSessions = 0;

    logs.forEach((l) => {
      if (totals[l.activity] !== undefined) {
        totals[l.activity] += Number(l.distance || 0);
      }
      if (l.activity === "badminton") badmintonSessions += 1;
    });

    document.getElementById("summary").innerText =
      `Run: ${totals.run.toFixed(1)} km | Bike: ${totals.bike.toFixed(1)} km | Swim: ${totals.swim.toFixed(1)} km | Badminton sessions: ${badmintonSessions}`;

    // Basic coaching feedback (we‚Äôll upgrade to AI later)
    let feedback = "Good consistency.";
    if (totals.run > totals.bike * 2 && totals.run > 5) feedback = "‚ö†Ô∏è Run-heavy week. Balance with bike/swim to reduce injury risk.";
    if (totals.swim < 1) feedback = "‚ö†Ô∏è Swimming volume is low. Add 1‚Äì2 easy swim sessions (even short ones).";
    if (badmintonSessions > 0) feedback += " (Remember: badminton counts as a hard leg day.)";

    document.getElementById("coachFeedback").innerText = feedback;
  }

  function renderChart() {
    const ctx = document.getElementById("chart").getContext("2d");

    const data = { run: 0, bike: 0, swim: 0 };

    logs.forEach((l) => {
      if (data[l.activity] !== undefined) {
        data[l.activity] += Number(l.distance || 0);
      }
    });

    if (chartInstance) chartInstance.destroy();

    chartInstance = new Chart(ctx, {
      type: "bar",
      data: {
        labels: ["Run", "Bike", "Swim"],
        datasets: [{
          label: "Total Distance (km)",
          data: [data.run, data.bike, data.swim],
        }],
      },
    });
  }

  // Load logs from cloud on startup
  loadAndRender();
</script>

</body>
</html>
